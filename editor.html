<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Editor</title>
	<style type="text/css" media="screen">
	body {
		overflow: hidden;
	}

	#editor {
		margin: 0;
		position: absolute;
		top: 0;
		bottom: 0;
		left: 0;
		right: 400px;
	}
	</style>
</head>
<body>

<pre id="editor">
let a 10
let b {($a+$a)/5+2}
print $b
jump a

#b
print {$b*2}
jump end

#a
print {$b+1}
let b {$b+1}
jump b

#end

</pre>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.2/ace.js"></script>
<script>
var editor = ace.edit("editor");
editor.setTheme("ace/theme/twilight");
editor.session.setMode("ace/mode/forth");


let env = {};
let lbl = {};
let program = [];
let pc = 0;

let src = editor.session.getValue()
let lines = src.split('\n');

/* parse source code */
for (let ln in lines) {
	let l = lines[ln].trim();
	if (l === '') {
		program.push([]);
		continue;
	}

	// label
	if (l[0] === '#') {
		lbl[l.slice(1)] = ln;
	}
	
	let lineTokens = tokenizeLine(l);
	program.push(lineTokens);
}

console.log(lbl)
console.log(program)

/* execute program */
while (pc < program.length) {
	evaluate(program[pc]);
	//console.log(pc+1, env)
	pc++;
}

function tokenizeLine(line) {
	let tokens = [];
	let current = '';
	for (let i = 0; i < line.length; i++) {
		let c = line[i];
		if (c === '{') {
			if (current !== '') {
				tokens.push(current);
				current = '';
			}
			i++;
			while (i < line.length && line[i] !== '}') {
				current += line[i];
				i++;
			}
		} else if (c != ' ') {
			current += c;
		} else {
			tokens.push(current);
			current = ''
		}
	}
	if (current !== '') {
		tokens.push(current);
	}
	return tokens;
}

function evaluate(ts) {
	if (ts.length === 0) {
		return;
	}
	if (ts[0][0] === '#') {
		return;
	}
	
	let cmd = ts[0];
	if (cmd === 'let') {
		env[ts[1]] = expression(ts[2]);
	} else if (cmd === 'print') {
		console.log(expression(ts[1]))
	} else if (cmd === 'jump') {
		// console.log('jump', ts[1], lbl[ts[1]])
		pc = lbl[ts[1]] - 1;
	} else {
		console.log('ignore', cmd)
	}
}

function expression(exp) {
	let varIdx = exp.indexOf('$');
	let varName = '';
	while (varIdx > -1) {
		varIdx++;
		while (varIdx < exp.length && '+-*/%!<>=()'.indexOf(exp[varIdx]) === -1) {
			varName += exp[varIdx];
			varIdx++;
		}
		// console.log(varName)
		exp = exp.replace('$'+varName, env[varName]);
		varName = '';
		varIdx = exp.indexOf('$');
		// console.log(exp);
	}
	
	return eval(exp);
}

</script>

</body>
</html>
